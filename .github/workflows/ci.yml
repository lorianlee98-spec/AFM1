name: CI - 代码检查与测试

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  backend-checks:
    name: 后端代码检查
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          cd backend
          pip install -r requirements.txt
          pip install black isort flake8 mypy
      
      - name: 代码格式化检查 (Black)
        run: |
          cd backend
          black --check --diff app/ || true
      
      - name: 导入排序检查 (isort)
        run: |
          cd backend
          isort --check-only --diff app/ || true
      
      - name: 代码风格检查 (Flake8)
        run: |
          cd backend
          flake8 app/ --max-line-length=120 --extend-ignore=E203,W503 || true
      
      - name: 类型检查 (MyPy)
        run: |
          cd backend
          mypy app/ --ignore-missing-imports || true

  frontend-checks:
    name: 前端代码检查
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: 安装依赖
        run: |
          cd frontend
          npm ci
      
      - name: 代码检查 (ESLint)
        run: |
          cd frontend
          npm run lint || true
      
      - name: 构建测试
        run: |
          cd frontend
          npm run build
