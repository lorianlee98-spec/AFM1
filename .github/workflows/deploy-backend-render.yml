name: Deploy Backend - Render

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'Dockerfile'
      - 'render.yaml'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  deploy:
    name: 部署后端到 Render
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 触发 Render 部署
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          curl --request POST \
            --url "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            --header "accept: application/json" \
            --header "authorization: Bearer $RENDER_API_KEY" \
            --header "content-type: application/json"
      
      - name: 等待部署完成
        run: |
          echo "⏳ 等待 Render 部署完成..."
          sleep 30
          echo "✅ 部署已触发，请访问 Render Dashboard 查看状态"
      
      - name: 部署成功通知
        if: success()
        run: |
          echo "✅ 后端部署已触发！"
          echo "Render Dashboard: https://dashboard.render.com"
